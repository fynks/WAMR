class WhatsAppChatReader{constructor(){this.chatData={messages:[],users:new Set,userColors:new Map,totalMessages:0,currentUser:null},this.elements={fileInput:document.getElementById("fileInput"),uploadSection:document.getElementById("uploadSection"),chatControls:document.getElementById("chatControls"),usersSection:document.getElementById("usersSection"),chatContainer:document.getElementById("chatContainer"),chatMessages:document.getElementById("chatMessages"),activeUserSelect:document.getElementById("activeUserSelect"),refreshBtn:document.getElementById("refreshBtn"),toggleUsersBtn:document.getElementById("toggleUsersBtn"),messageCount:document.getElementById("messageCount"),userCount:document.getElementById("userCount"),usersGrid:document.getElementById("usersGrid"),fileName:document.getElementById("fileName"),fileInfo:document.getElementById("fileInfo")},this.config={dateFormats:{english:/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s/,international:/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s/},systemMessages:["Messages and calls are end-to-end encrypted","Your security code with","security code changed","left","You're no longer","changed to","You removed","added","changed this group's","created group","You're now an admin","You created group","was added","changed the group description","joined using this group's","changed the subject","changed the group","started a call","Missed voice call","Missed video call","started calling","Calling...","was removed","You left","changed their phone number","This chat is with a business account"],months:["January","February","March","April","May","June","July","August","September","October","November","December"]},this.init()}init(){this.bindEvents(),this.generateUserColors()}bindEvents(){this.elements.fileInput.addEventListener("change",this.handleFileUpload.bind(this)),this.elements.activeUserSelect.addEventListener("change",this.handleUserPerspectiveChange.bind(this)),this.elements.refreshBtn.addEventListener("click",this.refreshPage.bind(this)),this.elements.toggleUsersBtn.addEventListener("click",this.toggleUsersSection.bind(this))}generateUserColors(){this.colorPalette=["#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffc107","#ff9800","#ff5722","#795548"]}async handleFileUpload(e){const t=e.target.files[0];if(t)if(t.name.toLowerCase().endsWith(".txt")){this.showLoading();try{const e=await this.readFile(t);await this.parseChat(e),this.displayResults(t.name)}catch(e){this.showError("Failed to process the chat file: "+e.message)}}else this.showError("Please select a valid .txt file")}readFile(e){return new Promise(((t,s)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=()=>s(new Error("Failed to read file")),a.readAsText(e)}))}async parseChat(e){const t=e.split("\n").filter((e=>e.trim()));this.chatData.messages=[],this.chatData.users.clear(),this.chatData.userColors.clear();let s=null,a=0;for(let e=0;e<t.length;e++){const n=t[e].trim();if(!n)continue;const i=this.parseMessageLine(n);if(i)this.chatData.userColors.has(i.sender)||(this.chatData.userColors.set(i.sender,this.colorPalette[a%this.colorPalette.length]),a++),this.chatData.users.add(i.sender),this.chatData.messages.push(i),s!==i.date&&(s=i.date);else if(this.isSystemMessage(n))this.chatData.messages.push({type:"system",content:this.cleanSystemMessage(n),timestamp:this.extractTimestamp(n),date:this.extractDate(n)});else if(this.chatData.messages.length>0){const e=this.chatData.messages[this.chatData.messages.length-1];"user"===e.type&&(e.content+="\n"+this.cleanMessageContent(n))}e%1e3==0&&await this.delay(1)}this.chatData.totalMessages=this.chatData.messages.filter((e=>"user"===e.type)).length}parseMessageLine(e){const t=[/^(\d{1,2}\/\d{1,2}\/\d{2,4}),\s+(\d{1,2}:\d{2}\s+(?:AM|PM))\s+-\s+([^:]+?):\s*(.*)$/,/^(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s+(\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM|am|pm)?)\s*[-‚Äì]\s*([^:]+?):\s*(.*)$/,/^\[(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s+(\d{1,2}:\d{2}(?::\d{2})?(?:\s*(?:AM|PM|am|pm))?)\]\s*([^:]+?):\s*(.*)$/,/^(\d{1,2}\/\d{1,2}\/\d{4}),?\s+(\d{1,2}:\d{2}(?::\d{2})?)\s*[-‚Äì]\s*([^:]+?):\s*(.*)$/];for(const s of t){const t=e.match(s);if(t){const[,s,a,n,i]=t;return this.isSystemMessageWithTimestamp(e)?null:{type:"user",date:this.normalizeDate(s),time:this.normalizeTime(a),sender:n.trim(),content:this.cleanMessageContent(i),timestamp:this.createTimestamp(s,a),isOutgoing:!1,isMedia:i.includes("<Media omitted>"),isDeleted:"null"===i.trim(),isEdited:i.includes("<This message was edited>")}}}return null}isSystemMessage(e){return this.config.systemMessages.some((t=>e.toLowerCase().includes(t.toLowerCase())))||this.isSystemMessageWithTimestamp(e)}isSystemMessageWithTimestamp(e){return/^\d{1,2}\/\d{1,2}\/\d{2,4},\s+\d{1,2}:\d{2}\s+(?:AM|PM)\s+-\s+(?!.*?:)(.+)$/.test(e)}cleanSystemMessage(e){return e.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},\s+\d{1,2}:\d{2}\s+(?:AM|PM)\s+-\s+/,"").replace(/^\d{1,2}\/\d{1,2}\/\d{2,4},?\s+\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM|am|pm)?\s*[-‚Äì]?\s*/,"").trim()}cleanMessageContent(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").trim()}normalizeDate(e){const t=e.split("/");let s=parseInt(t[2]);return s<100&&(s+=s<50?2e3:1900),`${t[0]}/${t[1]}/${s}`}normalizeTime(e){return e.trim()}createTimestamp(e,t){return`${e} ${t}`}extractDate(e){const t=e.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4}),\s+\d{1,2}:\d{2}\s+(?:AM|PM)\s+-/);if(t)return this.normalizeDate(t[1]);const s=e.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4})/);return s?this.normalizeDate(s[1]):null}extractTimestamp(e){const t=e.match(/(\d{1,2}:\d{2}\s+(?:AM|PM))/);if(t)return t[1];const s=e.match(/(\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM|am|pm)?)/);return s?s[1]:null}displayResults(e){this.elements.fileName.textContent=e,this.elements.fileInfo.classList.remove("hidden"),this.updateStats(),this.populateUserSelect(),this.populateUsersGrid(),this.renderMessages(),this.showChatInterface()}updateStats(){this.elements.messageCount.textContent=`${this.formatNumber(this.chatData.totalMessages)} messages loaded`,this.elements.userCount.textContent=`${this.chatData.users.size} participants`}populateUserSelect(){const e=this.elements.activeUserSelect;e.innerHTML='<option value="">All participants</option>',Array.from(this.chatData.users).sort().forEach((t=>{const s=document.createElement("option");s.value=t,s.textContent=t,e.appendChild(s)}))}populateUsersGrid(){const e=this.elements.usersGrid;e.innerHTML="",Array.from(this.chatData.users).sort().forEach((t=>{const s=this.createUserChip(t);e.appendChild(s)}))}createUserChip(e){const t=document.createElement("div");t.className="user-chip";const s=document.createElement("div");s.className="user-avatar",s.style.backgroundColor=this.chatData.userColors.get(e),s.textContent=this.getInitials(e);const a=document.createElement("span");return a.className="user-name",a.textContent=e,t.appendChild(s),t.appendChild(a),t}getInitials(e){return e.split(" ").map((e=>e.charAt(0))).join("").substring(0,2).toUpperCase()}renderMessages(){const e=this.elements.chatMessages;e.innerHTML="";let t=null;this.chatData.messages.forEach(((s,a)=>{s.date&&s.date!==t&&(e.appendChild(this.createDateSeparator(s.date)),t=s.date),"system"===s.type?e.appendChild(this.createSystemMessage(s)):"user"===s.type&&e.appendChild(this.createUserMessage(s))})),e.scrollTop=e.scrollHeight}createDateSeparator(e){const t=document.createElement("div");t.className="date-separator";const s=document.createElement("div");return s.className="date-badge",s.textContent=this.formatDate(e),t.appendChild(s),t}createSystemMessage(e){const t=document.createElement("div");t.className="system-message";const s=document.createElement("div");return s.className="system-message-text",s.textContent=e.content,t.appendChild(s),t}createUserMessage(e){const t=document.createElement("div");t.className="message "+(e.isOutgoing?"outgoing":"incoming"),e.isMedia&&t.classList.add("media-message"),e.isDeleted&&t.classList.add("deleted-message"),e.isEdited&&t.classList.add("edited-message");const s=document.createElement("div");if(s.className="message-bubble",!e.isOutgoing&&(this.chatData.users.size>2||!this.chatData.currentUser)){const t=document.createElement("div");t.className="message-header";const a=document.createElement("span");a.className="message-sender",a.style.color=this.chatData.userColors.get(e.sender),a.textContent=e.sender,t.appendChild(a),s.appendChild(t)}const a=document.createElement("div");a.className="message-content",a.innerHTML=this.formatMessageContent(e.content);const n=document.createElement("div");return n.className="message-time",n.textContent=e.time,s.appendChild(a),s.appendChild(n),t.appendChild(s),t}formatMessageContent(e){if(e.includes("<Media omitted>"))return'<span class="media-message">üìé Media</span>';if("null"===e.trim())return'<span class="deleted-message">üö´ This message was deleted</span>';e.includes("<This message was edited>")&&(e=e.replace("<This message was edited>",'<span class="edited-indicator">‚úèÔ∏è edited</span>'));return e=(e=e.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener" class="message-link">$1</a>')).replace(/\n/g,"<br>")}formatDate(e){const t=new Date,s=new Date(e),a=t.toDateString()===s.toDateString(),n=new Date(t-864e5).toDateString()===s.toDateString();if(a)return"Today";if(n)return"Yesterday";return s.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}formatNumber(e){return(new Intl.NumberFormat).format(e)}handleUserPerspectiveChange(e){const t=e.target.value;this.chatData.currentUser=t||null,this.chatData.messages.forEach((e=>{"user"===e.type&&(e.isOutgoing=!!t&&e.sender===t)})),this.renderMessages(),setTimeout((()=>{const e=this.elements.chatMessages;e.scrollTop=e.scrollHeight}),100)}showChatInterface(){this.elements.uploadSection.style.display="none",this.elements.chatControls.classList.add("visible"),this.elements.refreshBtn.style.display="flex",this.elements.toggleUsersBtn.style.display="flex",this.elements.chatContainer.style.display="flex",this.elements.chatContainer.style.flexDirection="column"}toggleUsersSection(){this.elements.usersSection.classList.contains("visible")?this.elements.usersSection.classList.remove("visible"):this.elements.usersSection.classList.add("visible")}showLoading(){this.elements.chatMessages.innerHTML='\n            <div class="loading">\n                <div class="spinner"></div>\n                Processing chat file...\n            </div>\n        '}showError(e){this.elements.chatMessages.innerHTML=`\n            <div class="error-message">\n                ${e}\n            </div>\n        `}refreshPage(){window.location.reload()}delay(e){return new Promise((t=>setTimeout(t,e)))}}document.addEventListener("DOMContentLoaded",(()=>{new WhatsAppChatReader})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"r"===e.key&&(e.preventDefault(),window.location.reload())}));